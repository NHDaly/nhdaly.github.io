---
layout: post-ipynb
title: Writing a simple SQL interpreter in Julia
author: Nathan Daly
index_description: >
  I'm finally setting up my blog! I have a few different posts I've put together over the years and I'll try to get them all up here now. :)
  But first, instead, here's one I wrote this week!
post_description: >
  <i>This post was generated from a jupyter notebook. You can download it here: <a href="https://github.com/NHDaly/SimpleSQL.jl/blob/master/SimpleSQL-example.ipynb">SimpleSQL-example.ipynb</a></i>
categories: [julia]
tags: [julia, sql, jupyter-notebook]
---

<!DOCTYPE html>
<body>
  <div class="JUPYTER-NOTEBOOK-EXPORT">
  <div tabindex="-1" id="notebook" class="border-box-sizing">
    <div class="container" id="notebook-container">

<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Writing-a-simple-SQL-interpreter-in-Julia">Writing a simple SQL interpreter in Julia<a class="anchor-link" href="#Writing-a-simple-SQL-interpreter-in-Julia">&#182;</a></h1><p>So I've felt for a while that databases and SQL were somewhat of a weak spot in my CS knowledge. I've never taken a databases class, nor really read much about them. Though a few years' on-the-job exposure did help some (I could, like, put together a query to get some data), it just didn't feel <em>intuitive</em>. I used to say things like, "but what does this <code>join</code> really <em>meannn</em>??? Like, what's it actually <em>doing!?</em>"</p>
<p>So I took the Khan Academy <a href="https://www.khanacademy.org/computing/computer-programming/sql">"Intro to SQL"</a> course over the weekend, and it was super helpful! I'd highly recommend it to anyone who felt like me. Cause it turns out, hey, a <code>join</code> is really simple! All it's doing is basically computing the Cartesian Product of your two tables, and then filtering out rows based on how you specified the query. No big deal.</p>
<hr>
<p>So then, of course, armed with my new knowledge, I couldn't resist trying to implement it all myself. And man, things like this are just so <em>fun</em> in julia!</p>
<p>So here's the result! I thought it would be fun to paste this up on the web just because it's a cool example of building a domain-specific-language within julia through its super expressive metaprogramming.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The code is all here, in this github repo, in a package called <code>SimpleSQL</code>:
<a href="https://github.com/NHDaly/SimpleSQL.jl">https://github.com/NHDaly/SimpleSQL.jl</a>
<br>It all fits in just this one file: <a href="https://github.com/NHDaly/SimpleSQL.jl/blob/master/src/SimpleSQL.jl">src/SimpleSQL.jl</a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So before I give any more details... <em>Look, it's just like SQL!:</em></p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="k">using</span> <span class="n">SimpleSQL</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="nd">@CREATE</span> <span class="nd">@TABLE</span> <span class="n">groceries</span> <span class="p">(</span><span class="o">:</span><span class="n">id</span><span class="p">,</span> <span class="kt">Int</span><span class="p">),</span> <span class="p">(</span><span class="o">:</span><span class="n">name</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span> <span class="p">(</span><span class="o">:</span><span class="n">quantity</span><span class="p">,</span> <span class="kt">Int</span><span class="p">),</span> <span class="p">(</span><span class="o">:</span><span class="n">aisle</span><span class="p">,</span> <span class="kt">Int</span><span class="p">)</span>
<span class="nd">@INSERT</span> <span class="nd">@INTO</span> <span class="n">groceries</span> <span class="nd">@VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Bananas&quot;</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
<span class="nd">@INSERT</span> <span class="nd">@INTO</span> <span class="n">groceries</span> <span class="nd">@VALUES</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Peanut Butter&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="nd">@INSERT</span> <span class="nd">@INTO</span> <span class="n">groceries</span> <span class="nd">@VALUES</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;Dark Chocolate Bars&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="nd">@INSERT</span> <span class="nd">@INTO</span> <span class="n">groceries</span> <span class="nd">@VALUES</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;Ice cream&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
<span class="nd">@INSERT</span> <span class="nd">@INTO</span> <span class="n">groceries</span> <span class="nd">@VALUES</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;Cherries&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="nd">@INSERT</span> <span class="nd">@INTO</span> <span class="n">groceries</span> <span class="nd">@VALUES</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;Chocolate syrup&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="nd">@SELECT</span> <span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="nd">@FROM</span> <span class="n">groceries</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[2]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>id |                name | quantity | aisle
---|---------------------|----------|------
 1 |             Bananas |       34 |     7
 2 |       Peanut Butter |        1 |     2
 3 | Dark Chocolate Bars |        2 |     2
 4 |           Ice cream |        1 |    12
 5 |            Cherries |        6 |     2
 6 |     Chocolate syrup |        1 |     4
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="nd">@SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">aisle</span><span class="p">,</span> <span class="n">quantity</span> <span class="nd">@FROM</span> <span class="n">groceries</span> <span class="nd">@WHERE</span> <span class="n">quantity</span> <span class="o">.&gt;</span> <span class="mi">1</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[3]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>               name | aisle | quantity
--------------------|-------|---------
            Bananas |     7 |       34
Dark Chocolate Bars |     2 |        2
           Cherries |     2 |        6
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="c"># How many unique things and total things do I have in each of the first 5 aisles in the store?</span>
<span class="nd">@SELECT</span> <span class="n">aisle</span><span class="p">,</span> <span class="n">length</span><span class="p">(</span><span class="n">aisle</span><span class="p">),</span> <span class="n">sum</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span> <span class="nd">@FROM</span> <span class="n">groceries</span> <span class="nd">@WHERE</span> <span class="n">aisle</span> <span class="o">.&lt;=</span> <span class="mi">5</span> <span class="nd">@GROUP</span> <span class="nd">@BY</span> <span class="n">aisle</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[4]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>aisle | length(aisle) | sum(quantity)
------|---------------|--------------
    2 |             3 |             9
    4 |             1 |             1
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Cool, right??</p>
<p>So yeah! In order to try to get a better sense of what SQL is doing, I built a small SQL emulator within julia. You can build up tables in memory, and then load and save them to disk. I only implemented a few of the basic commands, <code>CREATE TABLE</code>, <code>INSERT</code>, <code>SELECT FROM</code>, <code>GROUP BY</code>, and <code>WHERE</code>, but it was still a nice way to get a better sense for how these commands work.</p>
<p>My implementation basically boils down to keeping a tuple of column-vectors for each table, and all the query operations are just manipulating those vectors.</p>
<p><code>SELECT</code> just gets the matching column by header-name from the table. If the select query is a julia <em>expression</em> instead of a name, though, that expression is <em>evaluated</em> with the column name replaced with the column value! More on that later...</p>
<p><code>WHERE</code> creates a filtered copy of the vector, which is used for the rest of the query.</p>
<p><code>GROUP BY</code> goes through a vector, and creates a new vector of indices (e.g. <code>["a", "b", "a"] =&gt; [1,2,1]</code>), which is then used to split every <em>other</em> column vector into a bunch of row-vectors:</p>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="p">[[</span><span class="mi">5</span> <span class="mi">2</span><span class="p">],</span>  <span class="c"># group 1</span>
               <span class="p">[</span><span class="mi">10</span><span class="p">]]</span>    <span class="c"># group 2</span>
</pre></div>
<p>Then finally the query expressions are evaluated over each of those row-columns. So if the above steps came from this query: <code>@SELECT sum(a) @FROM t @GROUP @BY b</code>, then the output column will end up as the first element in each resulting row, creating <code>[7,10]</code>. Basically, like this:</p>
<div class="highlight"><pre><span></span><span class="p">[</span>
    <span class="n">sum</span><span class="p">([</span><span class="mi">5</span> <span class="mi">2</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>   <span class="c"># 7</span>
    <span class="n">sum</span><span class="p">([</span><span class="mi">10</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>    <span class="c"># 10</span>
   <span class="p">]</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Definitely the coolest thing about this package is <code>eval</code>ing the query expressions as native julia, because you can get access to all the powerful julia functions for free!</p>
<p>Here's another example, which showcases that a bit more:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="n">solar_system_objects</span> <span class="o">=</span> <span class="n">read_table_from_disk</span><span class="p">(</span><span class="s">&quot;solar_system_objects.table&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[5]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>solar_system_objects   32 rows
body::String
mean_radius::Real
mean_radius_rel::Real
volume::Real
volume_rel::Real
mass::Real
mass_rel::Real
density::Real
surface_gravity::Real
surface_gravity_rel::Real
type_of_object::String
shape::String
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="k">using</span> <span class="n">Statistics</span>  <span class="c"># For `mean` and `median`</span>
<span class="nd">@SQL</span> <span class="k">begin</span>
    <span class="nd">@SELECT</span> <span class="n">mean</span><span class="p">(</span><span class="n">density</span><span class="p">),</span> <span class="n">median</span><span class="p">(</span><span class="n">density</span><span class="p">),</span> <span class="n">round</span><span class="p">(</span><span class="n">sum</span><span class="p">(</span><span class="n">mass</span><span class="p">)),</span> <span class="n">type_of_object</span>
    <span class="nd">@FROM</span> <span class="n">solar_system_objects</span>
    <span class="nd">@WHERE</span> <span class="p">(</span><span class="nd">@.</span> <span class="o">!</span><span class="n">isnan</span><span class="p">(</span><span class="n">mass</span><span class="p">))</span>  <span class="c"># some elements are missing mass</span>
    <span class="nd">@GROUP</span> <span class="nd">@BY</span> <span class="n">type_of_object</span>
<span class="k">end</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[6]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>mean(density) | median(density) | round(sum(mass)) |                            type_of_object
--------------|-----------------|------------------|------------------------------------------
        1.408 |           1.408 |       1988550000 |                                      star
       1.0065 |          1.0065 |          2467060 |              planet (gas giant) has rings
        1.454 |           1.454 |           189262 |              planet (ice giant) has rings
     5.029375 |           5.335 |          11814.0 |                      planet (terrestrial)
   2.57784998 |          2.4745 |            393.0 |                      satellite of Jupiter
      1.33316 |           1.236 |            141.0 |                       satellite of Saturn
       3.3464 |          3.3464 |             74.0 |                        satellite of Earth
        2.061 |           2.061 |             22.0 |                      satellite of Neptune
         2.03 |            2.03 |             13.0 |             dwarf planet plutino multiple
         2.52 |            2.52 |             17.0 |                  dwarf planet @SDO binary
      1.59775 |           1.645 |              9.0 |                       satellite of Uranus
         2.55 |            2.55 |              4.0 | dwarf planet resoNaNt @KBO (7:12) trinary
         1.65 |            1.65 |              2.0 |                        satellite of Pluto
          2.2 |             2.2 |              1.0 |                           cubewano binary
        2.077 |           2.077 |              1.0 |                dwarf planet belt asteroid
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Getting those complex expressions to work turned out to be a fun exploration of <em>a few</em> of the different types of metaprogramming in julia.</p>
<p><a href="https://github.com/andyferris">Andy Ferris</a> gave a really nice explanation in his workshop at JuliaCon (<a href="https://youtu.be/SeqAQHKLNj4">"A practical introduction to metaprogramming in Julia"</a>) that julia actually does metaprogramming in lots of different ways.</p>
<p>There's macros, sure, which is what we typically think of as metaprogramming. And this package uses macros to let you to write queries in an SQL-like structure. (The macros are all the words starting with <code>@</code>.) But metaprogramming itself is more broad: it just means <em>any time</em> you <strong>treat your program itself as data</strong>. This concept comes from <code>lisp</code>, and it's central to how julia works: at runtime, julia is parsing every bit of the code you provide it into <em>julia</em> data structures: <code>Expr</code>s, <code>Symbol</code>s and literals (ints, strings, etc), and then evaluating those structures.</p>
<p>We can do the same thing ourselves, by creating those Expressions manually, and letting julia <code>eval</code> them! For example:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="kt">Expr</span><span class="p">(</span><span class="o">:</span><span class="n">call</span><span class="p">,</span> <span class="o">:+</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[7]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>:(2 + 3)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="n">eval</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[8]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>5</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[9]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="nb">e</span> <span class="o">=</span> <span class="k">quote</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">];</span> <span class="n">sum</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[9]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>quote
    #= In[9]:2 =#
    a = [1, 2]
    #= In[9]:2 =#
    sum(a)
end</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[10]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="n">eval</span><span class="p">(</span><span class="nb">e</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[10]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>3</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I used this functionality in this package to <em>automatically</em> implement every imaginable function you could call over your data!</p>
<p>That is, by constructing a simple <code>Expr</code> from your query and letting julia eval it, we get the <em>entire julia language</em> as part of our SQL language implementation, for free! That is so <em>cool!</em> So I didn't need to write a custom function for the <code>sum</code> of a column or the <code>length</code> of a column, because it's just normal julia code.</p>
<p>Which is really amazing, because not only is it easy to implement, it also allows you to be way more expressive with your data than you could ever be in SQL.</p>
<p>Want to know the value of <code>sin</code> for each aisle? <code>cos</code>? How about their comparisons? Why not! It's all just julia.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[11]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="nd">@SELECT</span> <span class="n">sin</span><span class="o">.</span><span class="p">(</span><span class="n">aisle</span><span class="p">),</span> <span class="n">cos</span><span class="o">.</span><span class="p">(</span><span class="n">aisle</span><span class="p">),</span> <span class="n">sin</span><span class="o">.</span><span class="p">(</span><span class="n">aisle</span><span class="p">)</span> <span class="o">.&gt;</span> <span class="n">cos</span><span class="o">.</span><span class="p">(</span><span class="n">aisle</span><span class="p">)</span> <span class="nd">@FROM</span> <span class="n">groceries</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[11]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>        sin.(aisle) |         cos.(aisle) | sin.(aisle) .&gt; cos.(aisle)
--------------------|---------------------|---------------------------
 0.6569865987187891 |  0.7539022543433046 |                      false
 0.9092974268256817 | -0.4161468365471424 |                       true
 0.9092974268256817 | -0.4161468365471424 |                       true
-0.5365729180004349 |  0.8438539587324921 |                      false
 0.9092974268256817 | -0.4161468365471424 |                       true
-0.7568024953079282 | -0.6536436208636119 |                      false
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Or all the items with chocolate?</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[12]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="nd">@SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">id</span> <span class="nd">@FROM</span> <span class="n">groceries</span> <span class="nd">@WHERE</span> <span class="n">occursin</span><span class="o">.</span><span class="p">(</span><span class="s">&quot;Chocolate&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[12]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>               name | id
--------------------|---
Dark Chocolate Bars |  3
    Chocolate syrup |  6
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And since these are just normal julia expressions, you can interpolate values into them too:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[13]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="n">prices</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.50</span><span class="p">,</span> <span class="mf">4.25</span><span class="p">]</span>  <span class="c"># This is the kind of thing you might normally use a JOIN for.</span>
<span class="nd">@SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="o">$</span><span class="n">prices</span> <span class="o">.*</span> <span class="n">quantity</span> <span class="nd">@FROM</span> <span class="n">groceries</span> <span class="nd">@WHERE</span> <span class="n">occursin</span><span class="o">.</span><span class="p">(</span><span class="s">&quot;Chocolate&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[13]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>               name | quantity | [2.5, 4.25] .* quantity
--------------------|----------|------------------------
Dark Chocolate Bars |        2 |                     5.0
    Chocolate syrup |        1 |                    4.25
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The way this works, is that <code>@SELECT</code> macro passes those query parameters to the <code>select_from</code> function as <code>Expr</code>s (<a href="https://github.com/NHDaly/SimpleSQL/blob/3a89a84843d3da360337358e48b76b512fbce922/src/SimpleSQL.jl#L334">here</a>).</p>
<p>Then, before it actually <em>evaluates</em> each expression (<code>:(sin.(aisle))</code> for example), it does two things:</p>
<ol>
<li>It digs into the expression to find the column name as a Symbol (<code>:aisle</code>).</li>
<li>Then it goes and gets that column from the table (via another <code>select_from</code> call) and replaces the column name with its value: <code>:(sin.([7; 2; 2; 12; 2; 4]))</code>.</li>
</ol>
<p>Now we can let julia evaluate that, and return it as a column. Isn't that cool?</p>
<p>Imagine trying to do something like this in <code>C++</code>... ðŸ¤¢</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As a result, we even get <em>control flow</em> within our queries, for free, even if it is ugly...</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[14]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="nd">@SELECT</span> <span class="k">if</span> <span class="p">(</span><span class="n">sum</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">);</span> <span class="p">[</span><span class="s">&quot;big...&quot;</span><span class="p">];</span> <span class="k">else</span> <span class="n">sum</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span> <span class="n">aisle</span> <span class="nd">@FROM</span> <span class="n">groceries</span> <span class="nd">@GROUP</span> <span class="nd">@BY</span> <span class="n">aisle</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[14]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>if sum(quantity) &gt; 10
    #= In[14]:1 =#
    [&#34;big...&#34;]
else
    #= In[14]:1 =#
    sum(quantity)
end | aisle
------------------------------------------------------------------------------------------------------|------
                                                                                               big... |     7
                                                                                                    1 |     2
                                                                                                    1 |    12
                                                                                                    1 |     4
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>
<p>This was just a fun way to spend a few afternoons, mostly just to try to solidify my understanding of what SQL is <em>doing</em> under the hood.</p>
<p>It's still definitely lacking in a bunch of ways, but it's neat nonetheless! One thing I was considering is whether I should be adding <code>@.</code> to all the expressions by default so you don't have to keep broadcasting everything above, but I left it out to be more explicit.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Sadly, I didn't implement <code>JOIN</code>. I think it wouldn't be very difficult, but I got tired of refactoring my <code>select_from</code> function every time I wanted to merge-in another bit of functionality. :]</p>
<p>In theory, though, a naive implementation would be something like creating new column-vectors for each column that comes out of your select statments, which are the Cartesian Product (<code>Ã—</code>) of those columns from each table, and then doing your <code>group by</code>, <code>on</code> and <code>where</code> over those.</p>
<p>There's probably lots of SQL stuff I didn't implement, but here are some I thought about doing:</p>
<ul>
<li><code>JOIN</code>s</li>
<li><code>AUTOINCREMENT PRIMARY KEY</code></li>
<li><code>AS</code></li>
<li>lowercase letterred macros.. lol</li>
<li>specifying only <em>some</em> of the values for <code>INSERT</code>.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>
<p>BUT, fret not! The julia community is full of so many smart people, that <em>of course</em> other people have already created several awesome packages which do the same sorts of things!</p>
<p>Allow me to take a moment to introduce... <a href="https://github.com/queryverse/Query.jl"><code>Query.jl</code></a>!</p>
<p><a href="https://github.com/davidanthoff">David Anthoff</a> has really done same amazing work for the data scene in julia, and this is just one awesome example.</p>
<p><code>Query.jl</code> let's you query over just about any type of data with this familiar sort of syntax.</p>
<div class="highlight"><pre><span></span><span class="n">julia</span><span class="o">&gt;</span> <span class="k">using</span> <span class="n">Query</span><span class="p">,</span> <span class="n">DataFrames</span>

<span class="n">julia</span><span class="o">&gt;</span> <span class="n">df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;John&quot;</span><span class="p">,</span> <span class="s">&quot;Sally&quot;</span><span class="p">,</span> <span class="s">&quot;Kirk&quot;</span><span class="p">],</span> <span class="n">age</span><span class="o">=</span><span class="p">[</span><span class="mf">23.</span><span class="p">,</span> <span class="mf">42.</span><span class="p">,</span> <span class="mf">59.</span><span class="p">],</span> <span class="n">children</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>

<span class="n">julia</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="nd">@from</span> <span class="n">i</span> <span class="kp">in</span> <span class="n">df</span> <span class="k">begin</span>
           <span class="nd">@where</span> <span class="n">i</span><span class="o">.</span><span class="n">age</span><span class="o">&gt;</span><span class="mi">50</span>
           <span class="nd">@select</span> <span class="p">{</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">children</span><span class="p">}</span>
           <span class="nd">@collect</span> <span class="n">DataFrame</span>
       <span class="k">end</span>
<span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="n">Ã—2</span> <span class="n">DataFrames</span><span class="o">.</span><span class="n">DataFrame</span>
<span class="n">â”‚</span> <span class="n">Row</span> <span class="n">â”‚</span> <span class="n">name</span>   <span class="n">â”‚</span> <span class="n">children</span> <span class="n">â”‚</span>
<span class="n">â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="n">â”‚</span> <span class="mi">1</span>   <span class="n">â”‚</span> <span class="s">&quot;Kirk&quot;</span> <span class="n">â”‚</span> <span class="mi">2</span>        <span class="n">â”‚</span>
</pre></div>
<p>Looks familiar, right? It's really neat. In fact, more broadly, this idea of adding an SQL-inspired syntax for querying <em>any</em> datasource (not just an SQL table) comes from <a href="https://msdn.microsoft.com/en-us/library/bb308959.aspx">Microsoft's LINQ</a>, which added this feature to <code>C#</code> more than 10 years ago.</p>
<p>The neat thing about julia's metaprogramming capabilities is that this same concept can be added to Julia via user-space <em>packages</em>, rather than needing to be a core part of the language.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Another approach is in <a href="https://github.com/JuliaDatabases/MySQL.jl">MySQL.jl</a> which allows you to simply communicate with a running MySQL server directly:</p>
<div class="highlight"><pre><span></span><span class="k">using</span> <span class="n">MySQL</span>
<span class="k">using</span> <span class="n">DataFrames</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">MySQL</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;localhost&quot;</span><span class="p">,</span> <span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="s">&quot;password&quot;</span><span class="p">,</span> <span class="n">db</span> <span class="o">=</span> <span class="s">&quot;test_db&quot;</span><span class="p">)</span>

<span class="n">foo</span> <span class="o">=</span> <span class="n">MySQL</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s">&quot;&quot;&quot;SELECT COUNT(*) FROM my_first_table;&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">DataFrame</span><span class="p">)</span>
<span class="n">num_foo</span> <span class="o">=</span> <span class="n">foo</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>There are a bunch of other data querying packages in julia, as well, all exploring this concept and taking it in different directions. One example: <code>Query.jl</code>, mentioned above, now lets you mix these query operation concepts into normal code as standalone functions, e.g. <code>peraisle = @groupby(df, _.aisle)</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>
<p>Finally, also, it's worth noting that I haven't really thought about performance at all. From what I've read, I think most SQL implementations work by first creating a query plan which takes into account the entire query, and then execute it.</p>
<p>In contrast, what I've done here sort of does each step as it reads it, which can result in extra work being done than is needed.</p>
<p>I think it's probably more appropriate to call this an SQL intepreter, rather than a proper implementation, since it's evaluating these query statements directly, rather than compiling them into a more appropriate representation (query plan) and running that in the traditional way. But I dunno, those are blurry words in this context, I think.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Hopefully you enjoyed this post! I enjoyed learning more about SQL and practicing metaprogramming in the process! It was lots of fun, and actually, relatively easy!</p>

</div>
</div>
</div>
    </div>
  </div>
</div>
</body>
